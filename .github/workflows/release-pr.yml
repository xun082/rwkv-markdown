name: Auto Version on Release PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  auto-version:
    name: Auto Update Version from Branch Name
    runs-on: ubuntu-latest
    
    # åªåœ¨ release/ å¼€å¤´çš„åˆ†æ”¯è¿è¡Œ
    if: startsWith(github.head_ref, 'release/')
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Extract Version from Branch Name
        id: extract_version
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          VERSION=$(echo $BRANCH_NAME | sed 's/release\///')
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ (x.y.z)
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: release/x.y.z (e.g., release/0.0.1)"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Extracted version: $VERSION"

      - name: Check if Version Already Updated
        id: check_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          TARGET_VERSION="${{ steps.extract_version.outputs.version }}"
          
          echo "Current version: $CURRENT_VERSION"
          echo "Target version: $TARGET_VERSION"
          
          if [ "$CURRENT_VERSION" = "$TARGET_VERSION" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ… Version already up to date"
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Version needs to be updated"
          fi

      - name: Update package.json Version
        if: steps.check_version.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          
          # ä½¿ç”¨ npm version å‘½ä»¤æ›´æ–°ç‰ˆæœ¬ï¼ˆä¸åˆ›å»º git tagï¼‰
          npm version $VERSION --no-git-tag-version
          
          echo "âœ… Updated package.json to version $VERSION"

      - name: Create Changeset
        if: steps.check_version.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          TIMESTAMP=$(date +%s)
          CHANGESET_FILE=".changeset/release-${VERSION}-${TIMESTAMP}.md"
          
          mkdir -p .changeset
          
          cat > $CHANGESET_FILE << EOF
---
"rwkv-markdown": patch
---

Release version $VERSION
EOF
          
          echo "âœ… Created changeset: $CHANGESET_FILE"

      - name: Commit and Push Changes
        if: steps.check_version.outputs.needs_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add package.json .changeset/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "chore: bump version to ${{ steps.extract_version.outputs.version }}"
            git push origin ${{ github.head_ref }}
            echo "âœ… Committed and pushed version update"
          fi

      - name: Add PR Comment
        if: steps.check_version.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.extract_version.outputs.version }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸš€ **Auto Version Update**\n\nVersion has been automatically updated to \`${version}\` based on the branch name.\n\nâœ… Changes:\n- Updated \`package.json\` version\n- Created changeset for release\n\nPlease review and merge when ready!`
            });

      - name: Add Success Summary
        if: steps.check_version.outputs.needs_update == 'true'
        run: |
          echo "### ðŸŽ‰ Version Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.extract_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… package.json updated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Changeset created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Changes committed and pushed" >> $GITHUB_STEP_SUMMARY

      - name: Add Skip Summary
        if: steps.check_version.outputs.needs_update == 'false'
        run: |
          echo "### â„¹ï¸ Version Already Up to Date" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current Version:** \`${{ steps.extract_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No updates needed. Version is already set correctly." >> $GITHUB_STEP_SUMMARY
